server:
  port: ${GATEWAY_PORT:8080}

spring:
  application:
    name: api-gateway

  cloud:
    compatibility-verifier:
      enabled: false

    gateway:
      # Configuración de CORS global
      globalcors:
        cors-configurations:
          '[/**]':
            allowed-origins: ${CORS_ALLOWED_ORIGINS:http://localhost:5173}
            allowed-methods: ${CORS_ALLOWED_METHODS:GET,POST,PUT,DELETE,OPTIONS,PATCH}
            allowed-headers: ${CORS_ALLOWED_HEADERS:*}
            allow-credentials: true
            max-age: 3600

      # Rutas dinámicas con descubrimiento de servicios
      discovery:
        locator:
          enabled: true
          lower-case-service-id: true

      # Rutas específicas
      routes:
        # ==================== AUTH SERVICE ====================
        - id: auth-register
          uri: lb://auth-service
          predicates:
            - Path=/api/v1/auth/register
          filters:
            - StripPrefix=2

        - id: auth-login
          uri: lb://auth-service
          predicates:
            - Path=/api/v1/auth/login
          filters:
            - StripPrefix=2

        - id: auth-service
          uri: lb://auth-service
          predicates:
            - Path=/api/v1/auth/**
          filters:
            - StripPrefix=2

        # ==================== MATRICULAS SERVICE ====================
        # Facultades
        - id: matriculas-facultades
          uri: lb://matriculas-service
          predicates:
            - Path=/api/v1/matriculas/facultades/**
          filters:
            - StripPrefix=3

        # Carreras
        - id: matriculas-carreras
          uri: lb://matriculas-service
          predicates:
            - Path=/api/v1/matriculas/carreras/**
          filters:
            - StripPrefix=3

        # Ruta genérica para matrículas
        - id: matriculas-service
          uri: lb://matriculas-service
          predicates:
            - Path=/api/v1/matriculas/**
          filters:
            - StripPrefix=3

        # ==================== AUDIT SERVICE ====================
        - id: audit-service
          uri: lb://audit-service
          predicates:
            - Path=/api/v1/audit/**
          filters:
            - StripPrefix=2

        # ==================== EMAIL SERVICE ====================
        # Solo para admin/health
        - id: email-service
          uri: lb://email-service
          predicates:
            - Path=/api/v1/email/**
          filters:
            - StripPrefix=2

# EUREKA CLIENT
eureka:
  client:
    service-url:
      defaultZone: ${EUREKA_URL:http://localhost:8761/eureka/}
    register-with-eureka: true
    fetch-registry: true
  instance:
    prefer-ip-address: true
    instance-id: ${spring.application.name}:${server.port}

# ACTUATOR
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,gateway
  endpoint:
    health:
      show-details: always
    gateway:
      enabled: true

# LOGGING
logging:
  level:
    root: ${LOGGING_LEVEL_ROOT:INFO}
    com.university.gateway: ${LOGGING_LEVEL_APP:DEBUG}
    org.springframework.cloud.gateway: DEBUG
    org.springframework.cloud.gateway.route: DEBUG
    reactor.netty: DEBUG